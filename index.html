<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//sohow.cc/css/fonts.css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="sohow">
<meta property="og:url" content="https://sohow.cc/index.html">
<meta property="og:site_name" content="sohow">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="sohow">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://sohow.cc/"/>





  <title> sohow </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">sohow</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2018/02/23/高并发解决方案之NGINX缓存/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/02/23/高并发解决方案之NGINX缓存/" itemprop="url">
                  高并发解决方案之NGINX缓存
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-23T17:02:08+08:00">
                2018-02-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>使用ngx_lua模块在Nginx层做缓存，可动态控制缓存开关，可做静态方案或者降级方案，<br>在公司的一个专题页项目中使用该方案，QPS提高了20倍</p>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="/images/nginx_cache.png" alt=""></p>
<h2 id="Lua代码文件"><a href="#Lua代码文件" class="headerlink" title="Lua代码文件"></a>Lua代码文件</h2><h3 id="header-filter-lua文件"><a href="#header-filter-lua文件" class="headerlink" title="header_filter.lua文件"></a>header_filter.lua文件</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ngx.header.NgxCache = ngx.var.is_cache</div></pre></td></tr></table></figure>
<h3 id="access-lua文件"><a href="#access-lua文件" class="headerlink" title="access.lua文件"></a>access.lua文件</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_from_cache</span><span class="params">(key)</span></span></div><div class="line">        <span class="keyword">local</span> cache_ngx = ngx.shared.ngx_cache</div><div class="line">        <span class="keyword">local</span> value = cache_ngx:get(key)</div><div class="line">        <span class="keyword">return</span> value</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_to_cache</span><span class="params">(key, value, exptime)</span></span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> exptime <span class="keyword">then</span></div><div class="line">                exptime = <span class="number">0</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">        <span class="keyword">local</span> cache_ngx = ngx.shared.ngx_cache</div><div class="line">        <span class="keyword">local</span> succ, err, forcible = cache_ngx:set(key, value, exptime)</div><div class="line">        <span class="keyword">return</span> succ</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_add</span><span class="params">(key, value, exptime)</span></span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> exptime <span class="keyword">then</span></div><div class="line">                exptime = <span class="number">0</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">        <span class="keyword">local</span> cache_ngx = ngx.shared.ngx_cache</div><div class="line">        <span class="keyword">local</span> succ, err, forcible = cache_ngx:safe_add(key, value, exptime)</div><div class="line">        <span class="keyword">return</span> succ</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_from_php</span><span class="params">(k, kk, flag, exptime)</span></span></div><div class="line">        <span class="keyword">local</span> options = &#123;&#125;</div><div class="line">        options[<span class="string">"method"</span>] = ngx.var.request_method == <span class="string">"GET"</span> <span class="keyword">and</span> ngx.HTTP_GET <span class="keyword">or</span> ngx.HTTP_POST</div><div class="line">        options[<span class="string">"body"</span>] = ngx.var.request_body</div><div class="line">        <span class="keyword">if</span> ngx.var.args == <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line">                ngx.var.args = <span class="string">"debug=0"</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">        <span class="keyword">local</span> args = ngx.decode_args(ngx.var.args)</div><div class="line">        args.subrequest = flag</div><div class="line">        options[<span class="string">"args"</span>] = args</div><div class="line">        <span class="keyword">local</span> uri = ngx.var.uri</div><div class="line">        <span class="keyword">local</span> res = ngx.location.capture(<span class="string">"/index.php"</span>..uri, options)</div><div class="line">        <span class="keyword">if</span> res.<span class="built_in">status</span> == <span class="number">200</span> <span class="keyword">then</span></div><div class="line">                <span class="keyword">if</span> flag == <span class="string">"open"</span> <span class="keyword">then</span></div><div class="line">                        set_to_cache(k, res.body, exptime)</div><div class="line">                        set_to_cache(kk, res.body, exptime*<span class="number">3</span>)</div><div class="line">                <span class="keyword">end</span></div><div class="line">                <span class="keyword">return</span> res.body</div><div class="line">        <span class="keyword">else</span></div><div class="line">                <span class="keyword">return</span> res.<span class="built_in">status</span></div><div class="line">        <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">local</span> <span class="built_in">open</span> = <span class="string">"open"</span></div><div class="line"><span class="keyword">local</span> <span class="built_in">close</span> = <span class="string">"close"</span></div><div class="line"><span class="keyword">local</span> time = <span class="number">300</span></div><div class="line"></div><div class="line">ngx.req.read_body()</div><div class="line"><span class="keyword">local</span> k = ngx.req.get_post_args()[<span class="string">"containerid"</span>] <span class="keyword">or</span> <span class="string">"default"</span></div><div class="line"><span class="keyword">local</span> ctrlkey = ngx.req.get_uri_args()[<span class="string">"ctrlkey"</span>] <span class="keyword">or</span> <span class="string">""</span></div><div class="line"><span class="keyword">if</span> ctrlkey == <span class="built_in">open</span> <span class="keyword">or</span> ctrlkey == <span class="built_in">close</span> <span class="keyword">then</span></div><div class="line">        set_to_cache(<span class="string">"ctrlkey"</span>, ctrlkey, <span class="number">0</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"><span class="keyword">if</span> k == <span class="string">"default"</span> <span class="keyword">then</span></div><div class="line">	time = <span class="number">10</span>	</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> uri = string.sub(ngx.var.uri,<span class="number">1</span>,<span class="number">100</span>)</div><div class="line">k = ngx.var.request_method .. ngx.var.host .. uri .. k</div><div class="line"><span class="keyword">local</span> content = <span class="literal">nil</span></div><div class="line"><span class="keyword">local</span> sw = <span class="built_in">close</span></div><div class="line"><span class="keyword">local</span> kk = k .. <span class="string">"old"</span></div><div class="line"></div><div class="line">sw = get_from_cache(<span class="string">"ctrlkey"</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> sw == <span class="built_in">open</span> <span class="keyword">then</span></div><div class="line">        content = get_from_cache(k)</div><div class="line">        <span class="keyword">if</span> content ~= <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line">                ngx.var.is_cache = <span class="number">1</span></div><div class="line">        <span class="keyword">else</span></div><div class="line">                <span class="keyword">local</span> atom = safe_add(k .. sw, <span class="number">1</span>, <span class="number">5</span>)</div><div class="line">                <span class="keyword">if</span> atom == <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line">                        content = get_from_cache(kk)</div><div class="line">                        <span class="keyword">if</span> content == <span class="literal">nil</span> <span class="keyword">then</span></div><div class="line">                        	content = get_from_php(k, kk, sw, time)</div><div class="line">                                ngx.var.is_cache = <span class="number">4</span></div><div class="line">                        <span class="keyword">else</span></div><div class="line">                                ngx.var.is_cache = <span class="number">2</span></div><div class="line">                        <span class="keyword">end</span></div><div class="line">                <span class="keyword">else</span></div><div class="line">                        content = get_from_php(k, kk, sw, time)</div><div class="line">                        ngx.var.is_cache = <span class="number">3</span></div><div class="line">                <span class="keyword">end</span></div><div class="line">        <span class="keyword">end</span></div><div class="line"><span class="keyword">else</span></div><div class="line">        content = get_from_php(k, kk, sw, time)</div><div class="line"><span class="keyword">end</span></div><div class="line">ngx.<span class="built_in">print</span>(content)</div></pre></td></tr></table></figure>
<h2 id="Nginx主要配置"><a href="#Nginx主要配置" class="headerlink" title="Nginx主要配置"></a>Nginx主要配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">lua_code_cache on;</div><div class="line">lua_shared_dict ngx_cache 32m;</div><div class="line"></div><div class="line">#...</div><div class="line"></div><div class="line">set $flag 1;</div><div class="line">if ($arg_subrequest = &quot;&quot;) &#123;</div><div class="line">    set $flag &quot;1$&#123;flag&#125;&quot;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">if ($arg_containerid ~ &quot;newartificial&quot;) &#123;</div><div class="line">    set $flag &quot;1$&#123;flag&#125;&quot;;</div><div class="line">&#125;</div><div class="line">if ($arg_containerid = &quot;&quot;) &#123;</div><div class="line">    set $flag &quot;1$&#123;flag&#125;&quot;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">if ($uri ~ &quot;^/(path.*)$&quot;) &#123;</div><div class="line">    set $flag &quot;1$&#123;flag&#125;&quot;;</div><div class="line">&#125;</div><div class="line">if ($flag = &quot;1111&quot;) &#123;</div><div class="line">    rewrite &quot;(.*)&quot; $1 break;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#...</div><div class="line"></div><div class="line">location ~ /(.*)\.lua$ &#123;</div><div class="line">    deny all;</div><div class="line">&#125;</div><div class="line"></div><div class="line">location ^~ /path &#123;</div><div class="line">    default_type text/html;</div><div class="line">    set $is_cache 0;</div><div class="line"></div><div class="line">    header_filter_by_lua_file /XXXXX/lua/header_filter.lua;</div><div class="line">    access_by_lua_file /XXXXX/lua/access.lua;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="缓存开关控制脚本"><a href="#缓存开关控制脚本" class="headerlink" title="缓存开关控制脚本"></a>缓存开关控制脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"># ./ctrl.sh open 开启缓存</div><div class="line"># ./ctrl.sh open 关闭缓存</div><div class="line"></div><div class="line">ips=(10.x.x.x 10.x.x.x 10.x.x.x 10.x.x.x 10.x.x.x 10.x.x.x)</div><div class="line">if [ x$1 != x ]; then</div><div class="line">    state=$1</div><div class="line">else</div><div class="line">	echo &quot;need param open or close&quot;</div><div class="line">    exit 1</div><div class="line">fi</div><div class="line"></div><div class="line">state=$1</div><div class="line">for ip in $&#123;ips[@]&#125;;</div><div class="line">do</div><div class="line">    curl -v -x &quot;$ip:80&quot; -d &quot;uid=xxx&quot; &quot;http://host/path?ctrlkey=$state&quot;</div><div class="line">	echo &quot;&quot;</div><div class="line">done</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/06/15/redis源码阅读之跳跃表skiplist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/15/redis源码阅读之跳跃表skiplist/" itemprop="url">
                  redis源码阅读之跳跃表skiplist
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-15T15:19:11+08:00">
                2017-06-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="redis跳跃表插入"><a href="#redis跳跃表插入" class="headerlink" title="redis跳跃表插入"></a>redis跳跃表插入</h2><ul>
<li>span表示当前层到下一个节点的对应层的跨度，存储在当前节点</li>
<li>rank[i]表示update[i]节点的排名</li>
<li>update[i]表示i层的第一个要插入节点的前驱节点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">score: 2	 span: 1 1 1 1 		    @@@@</div><div class="line">score: 26	 span: 1 1 1 1 1 7 	    @@@@@@</div><div class="line">score: 27	 span: 1 1 1 1 6 	    @@@@@</div><div class="line">score: 29	 span: 1 3 4 4 		    @@@@</div><div class="line">score: 63	 span: 1 		    @</div><div class="line">score: 67	 span: 1 		    @</div><div class="line">score: 83	 span: 1 1 		    @@</div><div class="line">score: 92	 span: 1 1 1 1 		    @@@@</div><div class="line">score: 93	 span: 0 0 		    @@</div><div class="line"></div><div class="line">rank: 2 update: 26</div><div class="line">rank: 3 update: 27</div><div class="line">rank: 4 update: 29</div><div class="line">rank: 4 update: 29</div><div class="line">rank: 4 update: 29</div><div class="line">rank: 6 update: 67</div><div class="line"></div><div class="line">score: 2	 span: 1 1 1 1 		    @@@@</div><div class="line">score: 26	 span: 1 1 1 1 1 5 	    @@@@@@</div><div class="line">score: 27	 span: 1 1 1 1 4 	    @@@@@</div><div class="line">score: 29	 span: 1 3 3 3 		    @@@@</div><div class="line">score: 63	 span: 1 		    @</div><div class="line">score: 67	 span: 1 		    @</div><div class="line">score: 69	 span: 1 1 2 2 3 3 3 3 	    @@@@@@@@</div><div class="line">score: 83	 span: 1 1 		    @@</div><div class="line">score: 92	 span: 1 1 1 1 		    @@@@</div><div class="line">score: 93	 span: 0 0 		    @@</div><div class="line"></div><div class="line">x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[0] - rank[i]);</div><div class="line">3 = 7 - (6 - 2)</div><div class="line">update[i]-&gt;level[i].span = (rank[0] - rank[i]) + 1;</div><div class="line">5 = (6 - 2) + 1</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/06/13/跳跃表原理C语言实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/13/跳跃表原理C语言实现/" itemprop="url">
                  跳跃表原理C语言实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T15:41:53+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="跳跃表和传统链表图示"><a href="#跳跃表和传统链表图示" class="headerlink" title="跳跃表和传统链表图示"></a>跳跃表和传统链表图示</h2><ul>
<li>上图是传统链表，下图是跳跃表图示</li>
<li>可以简单理解跳跃表是在传统顺序链表上通过给节点增加额外（随机个数）指针来做索引，<br>其思想类似于折半查询的思想，其效率可以媲美红黑树。<br><img src="/images/skip_list.png" alt=""></li>
</ul>
<h2 id="跳跃表C语言实现"><a href="#跳跃表C语言实现" class="headerlink" title="跳跃表C语言实现"></a>跳跃表C语言实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_L 10</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> typekey;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> typevalue;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> Node</div><div class="line">&#123;</div><div class="line">    typekey key;</div><div class="line">    typevalue val;</div><div class="line">    <span class="keyword">int</span> level;</div><div class="line">    <span class="keyword">struct</span> Node * next[<span class="number">1</span>];</div><div class="line">&#125; Node;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> Skiplist</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> level;</div><div class="line">    Node * header;</div><div class="line">&#125; Skiplist;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">randomLevel</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> level=<span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span> (rand()%<span class="number">2</span>) &#123;</div><div class="line">        level++;</div><div class="line">    &#125;</div><div class="line">    level= (MAX_L &gt; level) ? level : MAX_L;</div><div class="line">    <span class="keyword">return</span> level;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">Node * <span class="title">create_node</span><span class="params">(<span class="keyword">int</span> level)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> (Node *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Node) + (level <span class="number">-1</span>)*<span class="keyword">sizeof</span>(Node*));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">Skiplist * <span class="title">create_skiplist</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    Skiplist *p = (Skiplist *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Skiplist));</div><div class="line">    p-&gt;level = <span class="number">0</span>;</div><div class="line">    p-&gt;header = create_node(MAX_L);</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_L; i++) &#123;</div><div class="line">        p-&gt;header-&gt;next[i] = <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> p;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function">typevalue <span class="title">search</span><span class="params">(Skiplist *<span class="built_in">list</span>, typekey key)</span></span></div><div class="line">&#123;</div><div class="line">    Node *q, *p = <span class="built_in">list</span>-&gt;header;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="built_in">list</span>-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; --i) &#123;</div><div class="line">        <span class="keyword">while</span> ((q = p-&gt;next[i]) &amp;&amp; q-&gt;key &lt; key) &#123;</div><div class="line">            p = q;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (q &amp;&amp; q-&gt;key == key) &#123;</div><div class="line">            <span class="keyword">return</span> q-&gt;val;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(Skiplist * <span class="built_in">list</span>, typekey key, typevalue val)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> level = randomLevel();</div><div class="line">    Node *pnode = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">    <span class="built_in">list</span>-&gt;level = <span class="built_in">list</span>-&gt;level &lt; level ? level : <span class="built_in">list</span>-&gt;level;</div><div class="line">    Node *q, *p = <span class="built_in">list</span>-&gt;header;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="built_in">list</span>-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; --i) &#123;</div><div class="line">        <span class="keyword">while</span> ((q = p-&gt;next[i]) &amp;&amp; q-&gt;key &lt; key) &#123;</div><div class="line">            p = q;</div><div class="line">        &#125;</div><div class="line">        ;注意可插入相同key的节点</div><div class="line">        <span class="keyword">if</span> (i &lt;= level <span class="number">-1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (pnode == <span class="literal">NULL</span>) &#123;</div><div class="line">                pnode = create_node(level);</div><div class="line">                pnode-&gt;key = key;</div><div class="line">                pnode-&gt;val = val;</div><div class="line">                pnode-&gt;level = level;</div><div class="line">            &#125;</div><div class="line">            p-&gt;next[i] = pnode;</div><div class="line">            pnode-&gt;next[i] = q;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_node</span><span class="params">(Skiplist *<span class="built_in">list</span>, typekey key)</span></span></div><div class="line">&#123;</div><div class="line">    Node *q, *p = <span class="built_in">list</span>-&gt;header;</div><div class="line">    Node *pnode = <span class="literal">NULL</span>;</div><div class="line">    ;若有相同key一次只删除一个</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="built_in">list</span>-&gt;level - <span class="number">1</span>; i &gt;= <span class="number">0</span> ; --i) &#123;</div><div class="line">        <span class="keyword">while</span> ((q = p-&gt;next[i]) &amp;&amp; q-&gt;key &lt; key) &#123;</div><div class="line">            p = q;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (q == <span class="literal">NULL</span> &amp;&amp; p == <span class="built_in">list</span>-&gt;header) &#123;</div><div class="line">            <span class="built_in">list</span>-&gt;level--;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (q &amp;&amp; q-&gt;key == key) &#123;</div><div class="line">            pnode = q;</div><div class="line">            p-&gt;next[i] = q-&gt;next[i];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pnode) &#123;</div><div class="line">        <span class="built_in">free</span>(pnode);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete_list</span><span class="params">(Skiplist *<span class="built_in">list</span>)</span></span></div><div class="line">&#123;</div><div class="line">    Node *p = <span class="built_in">list</span>-&gt;header;</div><div class="line">    <span class="keyword">while</span> ((p = p-&gt;next[<span class="number">0</span>])) &#123;</div><div class="line">        <span class="built_in">free</span>(p);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">free</span>(<span class="built_in">list</span>-&gt;header);</div><div class="line">    <span class="built_in">free</span>(<span class="built_in">list</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    Skiplist *<span class="built_in">list</span> = create_skiplist();</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">int</span> key;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">        key = rand() % <span class="number">100</span> + <span class="number">1</span>;</div><div class="line">        insert(<span class="built_in">list</span>, key, key);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d "</span>, key);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line"></div><div class="line">    typevalue val;</div><div class="line">    <span class="keyword">char</span> *s;</div><div class="line">    Node *p = <span class="built_in">list</span>-&gt;header;</div><div class="line">    <span class="keyword">while</span> ((p = p-&gt;next[<span class="number">0</span>])) &#123;</div><div class="line">        val = search(<span class="built_in">list</span>, p-&gt;key);</div><div class="line">        s = val == p-&gt;val ? <span class="string">"OK"</span> : <span class="string">"FAILED"</span>;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"search %s 0x%d val: %d level: %d"</span>, s, (<span class="keyword">int</span>) p, p-&gt;val, p-&gt;level);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">" ("</span>);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; p-&gt;level; ++j) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"0x%d "</span>, (<span class="keyword">int</span>) (p-&gt;next[j]));</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">")\n"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    delete_list(<span class="built_in">list</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="检查内存溢出"><a href="#检查内存溢出" class="headerlink" title="检查内存溢出"></a>检查内存溢出</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gcc -Wall main.c -g -o test</div><div class="line">valgrind --tool=memcheck --leak-check=full ./test</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/06/06/redis源码阅读之字典dict/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/06/redis源码阅读之字典dict/" itemprop="url">
                  redis源码阅读之字典dict
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-06T13:49:44+08:00">
                2017-06-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p><img src="/images/redis_dict.png" alt=""></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictEntry &#123;</div><div class="line">    <span class="keyword">void</span> *key;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">void</span> *val;</div><div class="line">        <span class="keyword">uint64_t</span> u64;</div><div class="line">        <span class="keyword">int64_t</span> s64;</div><div class="line">        <span class="keyword">double</span> d;</div><div class="line">    &#125; v;</div><div class="line">    <span class="keyword">struct</span> dictEntry *next;</div><div class="line">&#125; dictEntry;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictType &#123;</div><div class="line">    <span class="keyword">uint64_t</span> (*hashFunction)(<span class="keyword">const</span> <span class="keyword">void</span> *key);</div><div class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key);</div><div class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *obj);</div><div class="line">    <span class="keyword">int</span> (*keyCompare)(<span class="keyword">void</span> *privdata, <span class="keyword">const</span> <span class="keyword">void</span> *key1, <span class="keyword">const</span> <span class="keyword">void</span> *key2);</div><div class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *key);</div><div class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *privdata, <span class="keyword">void</span> *obj);</div><div class="line">&#125; dictType;</div><div class="line"></div><div class="line"><span class="comment">/* This is our hash table structure. Every dictionary has two of this as we</span></div><div class="line"> * implement incremental rehashing, for the old to the new table. */</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictht &#123;</div><div class="line">    dictEntry **table;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> sizemask;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> used;</div><div class="line">&#125; dictht;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dict &#123;</div><div class="line">    dictType *type;</div><div class="line">    <span class="keyword">void</span> *privdata;</div><div class="line">    dictht ht[<span class="number">2</span>];</div><div class="line">    <span class="keyword">long</span> rehashidx; <span class="comment">/* rehashing not in progress if rehashidx == -1 */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> iterators; <span class="comment">/* number of iterators currently running */</span></div><div class="line">&#125; dict;</div><div class="line"></div><div class="line"><span class="comment">/* If safe is set to 1 this is a safe iterator, that means, you can call</span></div><div class="line"> * dictAdd, dictFind, and other functions against the dictionary even while</div><div class="line"> * iterating. Otherwise it is a non safe iterator, and only dictNext()</div><div class="line"> * should be called while iterating. */</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> dictIterator &#123;</div><div class="line">    dict *d;</div><div class="line">    <span class="keyword">long</span> index;</div><div class="line">    <span class="keyword">int</span> table, safe;</div><div class="line">    dictEntry *entry, *nextEntry;</div><div class="line">    <span class="comment">/* unsafe iterator fingerprint for misuse detection. */</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> fingerprint;</div><div class="line">&#125; dictIterator;</div></pre></td></tr></table></figure>
<h2 id="hash函数"><a href="#hash函数" class="headerlink" title="hash函数"></a>hash函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* The default hashing function uses SipHash implementation</span></div><div class="line"> * in siphash.c. */</div><div class="line"></div><div class="line"><span class="keyword">uint64_t</span> siphash(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *in, <span class="keyword">const</span> <span class="keyword">size_t</span> inlen, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *k);</div><div class="line"><span class="keyword">uint64_t</span> siphash_nocase(<span class="keyword">const</span> <span class="keyword">uint8_t</span> *in, <span class="keyword">const</span> <span class="keyword">size_t</span> inlen, <span class="keyword">const</span> <span class="keyword">uint8_t</span> *k);</div></pre></td></tr></table></figure>
<h2 id="解决hash冲突"><a href="#解决hash冲突" class="headerlink" title="解决hash冲突"></a>解决hash冲突</h2><ul>
<li>拉链法解决冲突</li>
</ul>
<h2 id="解决拉链法解决冲突的弊端"><a href="#解决拉链法解决冲突的弊端" class="headerlink" title="解决拉链法解决冲突的弊端"></a>解决拉链法解决冲突的弊端</h2><p>redis使用的是渐进式重散列(incremental rehashing)</p>
<ul>
<li>重散列<br>创建一个更大的hash表，把原来旧的数据一次性全部重新hash到新的表上。</li>
<li>渐进式重散列<br>创建一个更大的hash表，把原来旧的数据分步(如get或者set操作时，每次都只重新hash1个)重新hash到新的表上。<br>如上图dict中有两个hash tabe, 其中ht[1]就是在重散列时用到的。</li>
</ul>
<h2 id="渐进式重散列的时机"><a href="#渐进式重散列的时机" class="headerlink" title="渐进式重散列的时机"></a>渐进式重散列的时机</h2><ul>
<li>get</li>
<li>set</li>
<li>delete</li>
<li>…</li>
</ul>
<h2 id="反向递增二进制扫描器-dictScan"><a href="#反向递增二进制扫描器-dictScan" class="headerlink" title="反向递增二进制扫描器(dictScan)"></a>反向递增二进制扫描器(dictScan)</h2><ul>
<li><p>正常的游标递增是从1,2,3,4,5 … 自然数加1递增的, 用二进制描述是从最低位加1, 若溢出则向高位进位。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">000 001 010 011 100 101 110 111</div></pre></td></tr></table></figure>
</li>
<li><p>而dictScan的游标递增方式比较特别， 用二进制描述是从最高位加1, 若溢出则向低位进位。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">000 100 010 110 001 101 011 111</div></pre></td></tr></table></figure>
</li>
<li><p>dictScan采用这样特殊的游标递增方式是为了避免在扩容重散列时导致数据读取重复问题和缩容重散列时导致数据读取遗漏。</p>
</li>
<li>dictScan也不是完美的，其在扩容重散列时没有问题，但在缩容重散列时有可能会导致读取到少量重复数据。</li>
</ul>
<h3 id="扩容和缩容前后游标对应关系图"><a href="#扩容和缩容前后游标对应关系图" class="headerlink" title="扩容和缩容前后游标对应关系图"></a>扩容和缩容前后游标对应关系图</h3><p><img src="/images/redis_dict_scan.png" alt=""></p>
<ul>
<li>上图是扩容，通俗点理解原来一个变成了两个，由于原来的到新的没有重合的，所以没有重复读取的情况</li>
<li>下图是缩容，通俗点理解原来两个变成了一个，由于原来到新的是合二为一有重合，所以有可能会出现重复读取的情况，但这也是为了不遗漏数据所必要的，<br>没有重复的情况是当下一个应读取下一组时就不会读取到重复数据。 另外，重复bucket的数量=(bigger_table_size / smaller_table_size) - 1</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/06/05/编程技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/05/编程技巧/" itemprop="url">
                  编程技巧
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-05T17:16:28+08:00">
                2017-06-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="快速求余"><a href="#快速求余" class="headerlink" title="快速求余"></a>快速求余</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">a % x = a &amp; (x  - 1 ) 当x=2^n</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/06/05/redis源码阅读之双端双向链表adlist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/05/redis源码阅读之双端双向链表adlist/" itemprop="url">
                  redis源码阅读之双端双向链表adlist
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-05T14:19:11+08:00">
                2017-06-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="双端双向链表"><a href="#双端双向链表" class="headerlink" title="双端双向链表"></a>双端双向链表</h2><ul>
<li>双链表优点是便于逆向查找</li>
<li>双端优点是便于插入尾部</li>
</ul>
<h3 id="adlist结构图"><a href="#adlist结构图" class="headerlink" title="adlist结构图"></a>adlist结构图</h3><p><img src="/images/redis_adlist.png" alt=""></p>
<h3 id="adlist结构体"><a href="#adlist结构体" class="headerlink" title="adlist结构体"></a>adlist结构体</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">typedef struct listNode &#123;</div><div class="line">    struct listNode *prev;</div><div class="line">    struct listNode *next;</div><div class="line">    void *value;</div><div class="line">&#125; listNode;</div><div class="line"></div><div class="line">typedef struct listIter &#123;</div><div class="line">    listNode *next;</div><div class="line">    int direction;</div><div class="line">&#125; listIter;</div><div class="line"></div><div class="line">typedef struct list &#123;</div><div class="line">    listNode *head;</div><div class="line">    listNode *tail;</div><div class="line">    void *(*dup)(void *ptr);</div><div class="line">    void (*free)(void *ptr);</div><div class="line">    int (*match)(void *ptr, void *key);</div><div class="line">    unsigned long len;</div><div class="line">&#125; list;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/05/31/redis源码阅读之动态字符串sds/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/31/redis源码阅读之动态字符串sds/" itemprop="url">
                  redis源码阅读之动态字符串sds
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-31T16:50:31+08:00">
                2017-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="sds优点"><a href="#sds优点" class="headerlink" title="sds优点"></a>sds优点</h2><ul>
<li>计算字符串长度时间复杂度由O(n)降低到O(1)</li>
<li>额外分配内存减少频繁的内存分配复制开销</li>
</ul>
<h2 id="sds内存分布"><a href="#sds内存分布" class="headerlink" title="sds内存分布"></a>sds内存分布</h2><p>图示为SDS_TYPE_5以上类型<br><img src="/images/redis_sds_mem.png" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/05/16/ngx-lua灵活定制fastcgi-cache缓存key/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/16/ngx-lua灵活定制fastcgi-cache缓存key/" itemprop="url">
                  ngx_lua灵活定制fastcgi_cache缓存key
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-16T11:16:53+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Web开发常见的几种缓存"><a href="#Web开发常见的几种缓存" class="headerlink" title="Web开发常见的几种缓存"></a>Web开发常见的几种缓存</h2><blockquote>
<ul>
<li>常用缓存（memcached和redis）</li>
<li>Nginx的缓存（标准模块缓存: proxy_cache和fastcgi_cache / 第三方模块做缓存: ngx_lua）</li>
<li>CDN缓存</li>
<li>浏览器缓存（Cache-Control和LocalStorage）</li>
</ul>
</blockquote>
<h2 id="proxy-cache和fastcgi-cache"><a href="#proxy-cache和fastcgi-cache" class="headerlink" title="proxy_cache和fastcgi_cache"></a>proxy_cache和fastcgi_cache</h2><p>proxy_cache和fastcgi_cache都为Nginx的内置缓存，proxy_cache主要用于反向代理时，对后端内容源服务器进行缓存，fastcgi_cache主要用于对FastCGI的动态程序进行缓存。<br>两者相关配置类似，以下为fastcgi_cache举例</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>  针对fastcgi（如：php-fpm）返回的内容缓存为静态文件(文件名是用Md5算法对Key进行哈希后所得，而Key可使用fastcgi_cache的相关指令来进行控制)<br>，在用户浏览时，无需重复请求后端fastcgi，而直接返回缓存的内容，减少了后端的语言解析以及数据库连接的消耗。</p>
<h3 id="数据流程图"><a href="#数据流程图" class="headerlink" title="数据流程图"></a>数据流程图</h3><p><img src="/images/http_process.png" alt=""></p>
<h3 id="指令注释"><a href="#指令注释" class="headerlink" title="指令注释"></a>指令注释</h3><h4 id="nginx的http作用域"><a href="#nginx的http作用域" class="headerlink" title="nginx的http作用域:"></a>nginx的http作用域:</h4><p>fastcgi_cache_path /home/wwwroot/yii.me/runtime/logs levels=1:2 keys_zone=keys_zone=zone:512m:1m inactive=1d<br>max_size=1g; #指定一个路径，目录结构等级，关键字区域存储时间和非活动删除时间。以及最大占用空间（keys_zone主要缓存key和文件元信息，不会缓存页面）</p>
<h4 id="nginx的location作用域"><a href="#nginx的location作用域" class="headerlink" title="nginx的location作用域:"></a>nginx的location作用域:</h4><p>fastcgi_cache zone;                                              #表示开启FastCGI缓存并为其指定一个名称:zone<br>fastcgi_cache_valid 1m;                                         #设置缓存时间1分钟<br>fastcgi_cache_min_uses  1;                                      #设置链接请求1次就被缓存<br>fastcgi_cache_use_stale error  timeout invalid_header http_500; #定义哪些情况下用过期缓存（如果对实效要求不高建议加updating，关闭fastcgi_cache_lock，可提高性能）<br>fastcgi_cache_methods GET POST;                                 #缓存GET和POST请求<br>fastcgi_cache_key “$cache_path$containerid$containerpage”;      #缓存key=页面+containerid+分页页码<br>fastcgi_ignore_headers Cache-Control Expires Set-Cookie;         #包含这些header的响应不缓存<br>fastcgi_cache_lock on;                                          #同时有请求处理的时候只有一个请求允许访问后端服务器，其余请求等待缓存结果或等待超时再进行响应<br>fastcgi_cache_lock_timeout 5s;                                  #等待超时时间5秒，超时则穿透，且不缓存穿透结果<br>fastcgi_cache_bypass $skip_cache;                               #非0不从cache中取<br>fastcgi_no_cache $skip_cache;                                   #非0不保存到cache</p>
<h3 id="性能提升"><a href="#性能提升" class="headerlink" title="性能提升"></a>性能提升</h3><p>以下测试使用的vps机器<br>ab -c10 -n50000 <a href="http://127.0.0.1:8080/echo.php" target="_blank" rel="external">http://127.0.0.1:8080/echo.php</a></p>
<ul>
<li>fastcgi_cache off Requests per second:    2441.56 [#/sec] (mean)</li>
<li>fastcgi_cache zone Requests per second:    3662.79 [#/sec] (mean)</li>
</ul>
<h2 id="ngx-lua模块"><a href="#ngx-lua模块" class="headerlink" title="ngx_lua模块"></a>ngx_lua模块</h2><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="http://wiki.jikexueyuan.com/project/openresty/openresty/sub_request.html" target="_blank" rel="external">OpenResty 最佳实践-子查询</a></li>
<li><a href="http://wiki.jikexueyuan.com/project/openresty/ngx_lua/cache.html" target="_blank" rel="external">OpenResty 最佳实践-缓存</a><h3 id="在ngx-lua模块中使用共享内存"><a href="#在ngx-lua模块中使用共享内存" class="headerlink" title="在ngx_lua模块中使用共享内存"></a>在ngx_lua模块中使用共享内存</h3></li>
<li>定义一个共享内存对象<br>语法：lua_shared_dict <name> <size><br>该命令主要是定义一块名为name的共享内存空间，内存大小为size。通过该命令定义的共享内存对象对于Nginx中所有worker进程都是可见的，当Nginx通过reload命令重启时，共享内存字典项会从新获取它的内容，而当Nginx<br>退出时，字典项的值将会丢失。<br>例子：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">location /testngxlua &#123;</div><div class="line">        default_type application/json;</div><div class="line">        charset utf8;</div><div class="line"></div><div class="line">        access_by_lua &apos;</div><div class="line">            function get_from_cache(key)</div><div class="line">                local cache_ngx = ngx.shared.my_cache</div><div class="line">                local value = cache_ngx:get(key)</div><div class="line">                return value</div><div class="line">            end</div><div class="line"></div><div class="line">            function set_to_cache(key, value, exptime)</div><div class="line">                if not exptime then</div><div class="line">                    exptime = 0</div><div class="line">                end</div><div class="line"></div><div class="line">                local cache_ngx = ngx.shared.my_cache</div><div class="line">                local succ, err, forcible = cache_ngx:set(key, value, exptime)</div><div class="line">                return succ</div><div class="line">            end</div><div class="line"></div><div class="line">            ngx.req.read_body()</div><div class="line">            local c = ngx.req.get_uri_args()[&quot;c&quot;] or &quot;&quot;</div><div class="line">            local str = get_from_cache(c)</div><div class="line"></div><div class="line">            if (str ~= nil) then</div><div class="line">                ngx.print(&quot;ngx_cache: &quot;..str)</div><div class="line">            else</div><div class="line">                local options = &#123;&#125;</div><div class="line">                options[&quot;method&quot;] = ngx.var.request_method == &quot;GET&quot; and ngx.HTTP_GET or ngx.HTTP_POST</div><div class="line">                options[&quot;body&quot;] = ngx.var.request_body</div><div class="line">                options[&quot;args&quot;] = ngx.var.args</div><div class="line">                local res = ngx.location.capture(&quot;/index.php&quot;..ngx.var.uri, options)</div><div class="line">                if res.status == 200 then</div><div class="line">                    set_to_cache(c, res.body, 300)</div><div class="line">                    ngx.print(res.body)</div><div class="line">                else</div><div class="line">                    ngx.say(res.status)</div><div class="line">                end</div><div class="line">            end</div><div class="line">        &apos;;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</size></name></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/05/16/Wanna-cry加密解密流程分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/16/Wanna-cry加密解密流程分析/" itemprop="url">
                  Wanna cry加密解密流程分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-16T10:52:29+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>永恒之蓝勒索病毒文件加密解密流程，核心使用RSA+AES</p>
<h2 id="加密流程"><a href="#加密流程" class="headerlink" title="加密流程"></a>加密流程</h2><ul>
<li>RSA秘钥A，公钥A.public硬编码在加密程序中，私钥A.private作者自己持有</li>
<li>每个用户随机生成一对RSA秘钥B，公钥B.public用于加密AES的key，私钥B.private被作者的公钥A.public进行RSA加密B.private.encypt</li>
<li>遍历加密后缀列表(没有.torrent)中的文件进行加密，每个文件随机生成一个128位的key，使用B.public对key进行RSA加密得key2</li>
<li>对原始文件F使用key2进行AES加密得F.encrypt</li>
<li>删除原始文件，把key2和F.encrypt写入新文件</li>
</ul>
<h2 id="解密流程"><a href="#解密流程" class="headerlink" title="解密流程"></a>解密流程</h2><ul>
<li>把B.private.encypt发给作者</li>
<li>作者使用A.private将B.private.encypt进行RSA解密还原成B.private</li>
<li>从被加密的文件中提取key2，使用B.private对key进行RSA解密还原成key</li>
<li>使用key对F.encrypt进行AES解密得F（原始文件）</li>
</ul>
<p>以上可知，只要作者的RSA私钥A.private不泄露，那些被加密的文件理论无法破解<br>而作者提出使用比特币作为支付方式，是利用比特币的匿名性和无法被冻结，但比特币的交易记录是公开的，作者没有办法把每笔交易和某个感染用户关联，所以即使支付赎金，也可能无法解密文件</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://sohow.cc/2017/05/12/linux有用的命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sohow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sohow">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/12/linux有用的命令/" itemprop="url">
                  linux有用的命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-12T11:17:25+08:00">
                2017-05-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="lsattr和chattr"><a href="#lsattr和chattr" class="headerlink" title="lsattr和chattr"></a>lsattr和chattr</h2><p>这两个命令是用来查看和改变文件、目录属性的，与chmod这个命令相比，chmod只是改变文件的读写、执行权限，更底层的属性控制是由chattr来改变的</p>
<h3 id="查看文件属性"><a href="#查看文件属性" class="headerlink" title="查看文件属性"></a>查看文件属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsattr /etc/sudoers</div></pre></td></tr></table></figure>
<h3 id="设置文件只读属性"><a href="#设置文件只读属性" class="headerlink" title="设置文件只读属性"></a>设置文件只读属性</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chattr -i /etc/sudoers</div><div class="line">chattr +i /etc/sudoers</div></pre></td></tr></table></figure>
<h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-v  显示指令执行过程。</div><div class="line">-w  &lt;超时秒数&gt;   设置等待连线的时间。</div><div class="line">-u  表示使用UDP协议</div><div class="line">-z  使用0输入/输出模式 (用来告诉 nc 报告开放的端口，而不是启动连接)</div></pre></td></tr></table></figure>
<h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nc -v -w 10 -z 192.168.0.100 8080  </div><div class="line">nc -w 2 -z 192.168.0.100 1-65535</div></pre></td></tr></table></figure>
<h3 id="传输文件"><a href="#传输文件" class="headerlink" title="传输文件"></a>传输文件</h3><ul>
<li><p>监听</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc -v -l -p 4444 &gt; demo.txt</div></pre></td></tr></table></figure>
</li>
<li><p>连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc -v 192.168.0.100 4444 &lt; demo.txt</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><h3 id="查找目录下的所有文件中是否含有某个字符串"><a href="#查找目录下的所有文件中是否含有某个字符串" class="headerlink" title="查找目录下的所有文件中是否含有某个字符串"></a>查找目录下的所有文件中是否含有某个字符串</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find .|xargs grep -ri &quot;IBM&quot;</div></pre></td></tr></table></figure>
<h3 id="查找目录下的所有文件中是否含有某个字符串-并且只打印出文件名"><a href="#查找目录下的所有文件中是否含有某个字符串-并且只打印出文件名" class="headerlink" title="查找目录下的所有文件中是否含有某个字符串,并且只打印出文件名"></a>查找目录下的所有文件中是否含有某个字符串,并且只打印出文件名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find .|xargs grep -ri &quot;IBM&quot; -l</div></pre></td></tr></table></figure>
<h3 id="查找文件"><a href="#查找文件" class="headerlink" title="查找文件"></a>查找文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">find . -name &quot;*.txt&quot;                    ;按照文件名</div><div class="line">find . -empty                           ;查找空文件</div><div class="line">find . -user himanshu -name &quot;*.txt&quot;     ;指定用户</div><div class="line">find . -szie -1024c + 256c              ;指定文件大小范围&gt;256字节&lt;1024字节</div></pre></td></tr></table></figure>
<h2 id="ll"><a href="#ll" class="headerlink" title="ll"></a>ll</h2><h3 id="文件排序"><a href="#文件排序" class="headerlink" title="文件排序"></a>文件排序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ll -S</div></pre></td></tr></table></figure>
<h3 id="统计文件个数"><a href="#统计文件个数" class="headerlink" title="统计文件个数"></a>统计文件个数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ll | grep &quot;^-&quot; | wc -l</div></pre></td></tr></table></figure>
<h2 id="notify-send"><a href="#notify-send" class="headerlink" title="notify-send"></a>notify-send</h2><ul>
<li><p>每周4下午3点显示一个提醒弹窗</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">00 15 * * 4 export DISPLAY=:0.0 &amp;&amp; sudo -u zongwen1 /usr/bin/notify-send &quot;[自定义提醒]&quot; &quot;该写周报了！&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>mac版弹窗命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">osascript -e &apos;display notification &quot;该写周报了！&quot; with title &quot;[自定义提醒]&quot;&apos;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="zssh"><a href="#zssh" class="headerlink" title="zssh"></a>zssh</h2><ul>
<li>zssh 配合 sz和rz 可以方便地通过shell传输文件</li>
</ul>
<h2 id="alias"><a href="#alias" class="headerlink" title="alias"></a>alias</h2><p>设置命令别名，可缩短命令长度<br>例如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo vim /home/当前用户/.bashrc     ;对当前用户有效</div><div class="line">sudo vim /etc/profile              ;全局用户有效</div><div class="line">source /etc/profile</div><div class="line">alias sqlmap=’python /path/sqlmap.py’</div></pre></td></tr></table></figure></p>
<h2 id="sqlmap"><a href="#sqlmap" class="headerlink" title="sqlmap"></a>sqlmap</h2><ul>
<li>需要python环境，下载后即可使用了</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/sqlmapproject/sqlmap.git</div><div class="line">cd sqlmap</div><div class="line">python sqlmap.py -u &quot;http://192.168.0.1/?id=1&quot; ;建议使用alias设置别名</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="sohow" />
          <p class="site-author-name" itemprop="name">sohow</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://qingyu.me" target="_blank" title="青鱼博客">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  青鱼博客
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sohow</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "3042edd3b9094c85b738513a6bb82ecc",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

</body>
</html>
